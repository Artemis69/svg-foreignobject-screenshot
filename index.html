<!DOCTYPE html>
<html>

    <meta charset="utf-8">

    <head>
        <link rel="stylesheet" type="text/css" href="styles.css" /> 
    </head>

    <body>

        <div id="snapshotContainer"></div>

        <script type="text/javascript">
        
            const run = async function() {

                const getResourceAsBase64 = function(url) {
                    return new Promise(function(resolve, reject) {
                        const xhr = new XMLHttpRequest();
                        xhr.open("GET", url);
                        xhr.responseType = 'blob';

                        xhr.onreadystatechange = function() {
                            if(xhr.readyState === 4 && xhr.status === 200) {
                                const reader = new FileReader();
                                reader.readAsDataURL(xhr.response); 
                                reader.onloadend = function() {
                                    resolve(reader.result);
                                }                               
                            }
                        };

                        xhr.send(null);
                    });
                };

                const removeQutoes = function(str) {
                    return str.replace(/['"]+/g, '');
                };

                const getUrlsFromCssString = function(cssRuleStr) {
                    const urlsFound = [];
                    let searchStartIndex = 0;

                    while(true) {
                        const idx = cssRuleStr.indexOf("url(", searchStartIndex);
                        if(idx === -1) {
                            break;
                        }

                        let url = "";
                        for(let i=idx+4; i<cssRuleStr.length; i++) {
                            if(cssRuleStr[i] === ')') {
                                break;
                            }
                            url += cssRuleStr[i];
                        }
                        
                        searchStartIndex = idx + 1;

                        urlsFound.push(removeQutoes(url));
                    }

                    return urlsFound;
                };

                const buildSvgDataUri = async function(contentHtml) {

                    return new Promise(async function(resolve, reject) {

                        /* !! The problems !!
                        *  1. CORS (not really an issue, expect perhaps for images, as this is a general security consideration to begin with)
                        *  2. Platform won't wait for external assets to load (fonts, images, etc.)
                        */ 

                        // copy styles
                        let cssStyles = "";
                        let urlsFound = [];

                        for (let i=0; i<document.styleSheets.length; i++) {
                            for(let j=0; j<document.styleSheets[i].cssRules.length; j++) {
                                const cssRuleStr = document.styleSheets[i].cssRules[j].cssText;
                                urlsFound.push( ...getUrlsFromCssString(cssRuleStr) );
                                cssStyles += cssRuleStr;
                            }
                        }

                        for(let i=0; i<urlsFound.length; i++) {
                            const resBase64 = await getResourceAsBase64(urlsFound[i]);
                            cssStyles = cssStyles.replace(`"${urlsFound[i]}"`, resBase64);
                        }

                        const styleElem = document.createElement("style");
                        styleElem.innerHTML = cssStyles;

                        const styleElemString = new XMLSerializer().serializeToString(styleElem);

                        // create DOM element string that encapsulates styles + content
                        const contentRootElem = document.createElement("div");
                        contentRootElem.innerHTML = styleElemString + contentHtml;
                        contentRootElem.setAttribute("xmlns", "http://www.w3.org/1999/xhtml");

                        const contentRootElemString = new XMLSerializer().serializeToString(contentRootElem);

                        // build SVG string
                        const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='960' height='850'><g transform='translate(0, 0) rotate(0)'><foreignObject x='0' y='0' width='800' height='800'>${contentRootElemString}</foreignObject></g></svg>`;

                        // convert SVG to data-uri
                        const dataUri = `data:image/svg+xml;base64,${window.btoa(svg)}`;

                        resolve(dataUri);                    

                    });
                };

                const img = new Image();
                img.src = await buildSvgDataUri(`<p style="border:2px solid #00f; padding:25px; border-radius:25px;">ABC ^ XYZ: <img src="test-bigfoot.svg" width="64" /></p>`);

                img.onload = function() {
                    document.getElementById(`snapshotContainer`).appendChild(img);
                };
            };

            run();

        </script>


    </body>


</html>
