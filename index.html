<!DOCTYPE html>
<html>

    <meta charset="utf-8">

    <head>
        <link rel="stylesheet" type="text/css" href="styles.css" /> 
    </head>

    <body>

        <p>XYZ</p>

        <div id="snapshotContainer"></div>

        <script type="text/javascript">
        
            const buildSvgDataUri = function(contentHtml) {

                // copy styles
                const styleElem = document.createElement("style");
                styleElem.innerHTML =  ``;

                for (let i=0; i<document.styleSheets.length; i++) {
                    for(let j=0; j<document.styleSheets[i].cssRules.length; j++) {
                        styleElem.innerHTML += document.styleSheets[i].cssRules[j].cssText;
                    }
                }


                /* !! The problems !!
                 *  1. CORS (not really an issue, expect perhaps for images, as this is a general security consideration to begin with)
                 *  2. Platform won't wait for external assets to load (fonts, images, etc.)
                */ 

                const styleElemString = new XMLSerializer().serializeToString(styleElem);

                // create DOM element string that encapsulates styles + content
                const contentRootElem = document.createElement("div");
                contentRootElem.innerHTML = styleElemString + contentHtml;
                contentRootElem.setAttribute("xmlns", "http://www.w3.org/1999/xhtml");

                const contentRootElemString = new XMLSerializer().serializeToString(contentRootElem);

                // build SVG string
                const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='960' height='850'><g transform='translate(300, 0) rotate(20)'><foreignObject x='0' y='0' width='800' height='800'>${contentRootElemString}</foreignObject></g></svg>`;

                // convert SVG to data-uri
                const dataUri = `data:image/svg+xml;base64,${window.btoa(svg)}`;

                return dataUri;
            };

            const img = new Image();
            img.src = buildSvgDataUri(`<p>ABC ^ XYZ: <img src="test-bigfoot.svg" width="64" /></p>`);

            img.onload = function() {
                document.getElementById(`snapshotContainer`).appendChild(img);
            };

        </script>


    </body>


</html>
